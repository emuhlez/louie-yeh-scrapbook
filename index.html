<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Scrapbook</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ============================================
       CSS VARIABLES - STRICT COLOR PALETTE
       ============================================ */
    :root {
      --bg-main: #ffffff;
      --bg-card: #F5F2EC;
      --text-primary: #000000;
      --text-secondary: #646464;
      --accent-neutral: #2D2520;
      --accent-light: #8B8680;
      --shadow-soft: rgba(45, 37, 32, 0.08);
      --shadow-medium: rgba(45, 37, 32, 0.15);
    }
    
    /* ============================================
       RESET & BASE STYLES
       ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 400;
      color: var(--text-primary);
      background: linear-gradient(135deg, #faf8f5 0%, #f5f0e8 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Radial gradient overlays for depth */
    body::before,
    body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }
    
    body::before {
      width: 800px;
      height: 800px;
      top: -400px;
      right: -400px;
      background: radial-gradient(circle, var(--accent-light) 0%, transparent 70%);
      opacity: 0.02;
    }
    
    body::after {
      width: 600px;
      height: 600px;
      bottom: -300px;
      left: -300px;
      background: radial-gradient(circle, var(--accent-light) 0%, transparent 70%);
      opacity: 0.02;
    }
    
    /* ============================================
       TYPOGRAPHY
       ============================================ */
    h1, h2, h3 {
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 700;
    }
    
    h1 {
      font-size: clamp(2rem, 5vw, 3rem);
    }
    
    h2 {
      font-size: clamp(1.5rem, 4vw, 2rem);
    }
    
    h3 {
      font-size: clamp(1.2rem, 3vw, 1.5rem);
    }
    
    p, label, button {
      font-family: 'IBM Plex Mono', monospace;
    }
    
    /* Secondary font for captions and letters */
    .caption,
    .letter-content,
    .memory-caption,
    .memory-text {
      font-family: 'Inter', sans-serif;
    }
    
    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ============================================
       CONTAINER & LAYOUT
       ============================================ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
      z-index: 1;
    }
    
    /* ============================================
       HEADER
       ============================================ */
    header {
      text-align: center;
      padding: 3rem 0;
      animation: fadeInDown 0.8s ease;
    }
    
    header h1 {
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    header h1 img {
      max-width: 400px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    
    header p {
      color: var(--text-secondary);
      font-size: clamp(1rem, 2vw, 1.2rem);
      font-weight: 300;
    }
    
    /* ============================================
       BUTTONS
       ============================================ */
    button {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 50px;
      background: var(--text-primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px var(--shadow-soft);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-medium);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* ============================================
       CARDS
       ============================================ */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px var(--shadow-soft);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px var(--shadow-medium);
    }
    
    /* ============================================
       MAIN CONTENT AREA
       ============================================ */
    main {
      min-height: 60vh;
      animation: fadeInUp 0.8s ease;
    }
    
    /* ============================================
       ACTION BUTTONS
       ============================================ */
    .action-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    
    .create-memory-btn {
      font-size: 1.1rem;
      padding: 1rem 2.5rem;
    }
    
    /* ============================================
       VIEW CONTROLS
       ============================================ */
    .view-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
    }
    
    .view-controls button {
      padding: 0.6rem 1.5rem;
      font-size: 0.9rem;
    }
    
    .view-controls button.active {
      background: var(--accent-neutral);
    }
    
    /* ============================================
       GRID VIEW
       ============================================ */
    .grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      animation: fadeIn 0.5s ease;
    }
    
    .memory-card {
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px var(--shadow-soft);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    
    .memory-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px var(--shadow-medium);
    }
    
    .memory-card-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
      background: var(--bg-card);
    }
    
    .memory-card-content {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .memory-card-type {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .memory-card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .memory-card-caption {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      line-height: 1.5;
    }
    
    .memory-card-date {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid rgba(45, 37, 32, 0.1);
    }
    
    /* Placeholder for content */
    .content-placeholder {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    /* ============================================
       MODAL
       ============================================ */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-backdrop.active {
      display: flex;
    }
    
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
    }
    
    .modal-header {
      margin-bottom: 1.5rem;
    }
    
    .modal-header h2 {
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .modal-header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
      transform: none;
    }
    
    /* ============================================
       FORM STYLES
       ============================================ */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid rgba(45, 37, 32, 0.2);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      color: var(--text-primary);
      background: var(--bg-main);
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--text-primary);
      box-shadow: 0 0 0 3px rgba(45, 37, 32, 0.1);
    }
    
    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .memory-type-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    
    .type-option {
      padding: 1rem;
      border: 2px solid rgba(45, 37, 32, 0.15);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg-main);
    }
    
    .type-option:hover {
      border-color: var(--text-primary);
      transform: translateY(-2px);
    }
    
    .type-option.active {
      border-color: var(--text-primary);
      background: rgba(45, 37, 32, 0.05);
    }
    
    .type-option-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    .type-option-label {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    
    .form-actions button {
      padding: 0.8rem 1.8rem;
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid var(--text-secondary);
      color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.05);
      border-color: var(--text-primary);
      color: var(--text-primary);
    }
    
    /* ============================================
       LANDING PAGE
       ============================================ */
    .landing-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #faf8f5 0%, #f5f0e8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      overflow: hidden;
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    
    .landing-page.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
    }
    
    .landing-title {
      text-align: center;
      cursor: pointer;
      z-index: 10;
      position: relative;
      padding: 2rem;
      transition: all 0.3s ease;
      user-select: none;
      max-width: 90%;
      width: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    
    .landing-title-main {
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
      transition: all 0.3s ease;
    }
    
    .landing-title-sub {
      width: 100%;
      max-width: 350px;
      height: auto;
      display: block;
      margin-left: 60px;
      transition: all 0.3s ease;
    }
    
    .landing-title:hover .landing-title-main,
    .landing-title:hover .landing-title-sub {
      transform: scale(1.05);
      opacity: 0.7;
    }
    
    .photo-stream {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      overflow: hidden;
    }
    
    .photo-stream-item {
      position: absolute;
      animation: streamLeft 30s linear infinite;
      white-space: nowrap;
      will-change: transform;
      pointer-events: auto;
      cursor: pointer;
    }
    
    .stream-photo {
      width: auto;
      height: 200px;
      border-radius: 0;
      object-fit: contain;
      box-shadow: 0 4px 20px var(--shadow-soft);
      opacity: 1;
      display: block;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .photo-stream-item:hover .stream-photo {
      transform: scale(1.1);
      box-shadow: 0 8px 30px var(--shadow-medium);
      z-index: 100;
    }
    
    @keyframes streamLeft {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-200vw);
      }
    }
    
    /* ============================================
       MOBILE RESPONSIVENESS
       ============================================ */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      header {
        padding: 2rem 0;
      }
      
      button {
        padding: 0.7rem 1.5rem;
        font-size: 0.9rem;
      }
      
      .grid-view {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .view-controls {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .view-controls button {
        width: 100%;
      }
      
      .memory-type-selector {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .modal {
        width: 95%;
        padding: 1.5rem;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .form-actions button {
        width: 100%;
      }
      
      .stream-photo {
        height: 160px !important;
      }
      
      .landing-title-main {
        max-width: 90%;
      }
      
      .landing-title-sub {
        max-width: 70%;
        margin-left: 40px;
      }
      
      header h1 img {
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Landing Page -->
  <div class="landing-page" id="landingPage">
    <div class="photo-stream" id="photoStream">
      <!-- Photo streams will be generated here -->
    </div>
    <div class="landing-title" id="landingTitle">
      <img class="landing-title-main" src="title/nate-emily-goose.svg" alt="nate + emily + goose">
      <img class="landing-title-sub" src="title/Scrapbook.svg" alt="scrapbook">
    </div>
  </div>
  
  <div class="container">
    <header>
      <h1><img src="title/nate-emily-goose.svg" alt="nate + emily + goose's scrapbook"></h1>
      <p>A collection of moments we cherish together</p>
    </header>
    
    <main>
      <div class="action-bar">
        <button class="create-memory-btn" id="createMemoryBtn">+ Create Memory</button>
      </div>
      
      <div class="view-controls">
        <button class="view-btn active" data-view="grid">Grid View</button>
        <button class="view-btn" data-view="scroll">3D Scroll View</button>
      </div>
      
      <div id="app-content">
        <!-- Content will be rendered here -->
      </div>
    </main>
  </div>
  
  <!-- Create Memory Modal -->
  <div class="modal-backdrop" id="createMemoryModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Create a New Memory</h2>
        <p>Choose a type and fill in the details</p>
      </div>
      
      <form id="createMemoryForm">
        <div class="form-group">
          <label>Memory Type</label>
          <div class="memory-type-selector">
            <div class="type-option" data-type="letter">
              <div class="type-option-icon">‚úâÔ∏è</div>
              <div class="type-option-label">Letter</div>
            </div>
            <div class="type-option" data-type="photo">
              <div class="type-option-icon">üì∑</div>
              <div class="type-option-label">Photo</div>
            </div>
            <div class="type-option" data-type="video">
              <div class="type-option-icon">üé¨</div>
              <div class="type-option-label">Video</div>
            </div>
          </div>
          <input type="hidden" id="memoryType" name="type" required>
        </div>
        
        <div class="form-group">
          <label for="memoryTitle">Title</label>
          <input type="text" id="memoryTitle" name="title" placeholder="Give this memory a name" required>
        </div>
        
        <div class="form-group">
          <label for="memoryDate">Date</label>
          <input type="date" id="memoryDate" name="date" required>
        </div>
        
        <div class="form-group">
          <label for="memoryContent">Content</label>
          <textarea id="memoryContent" name="content" placeholder="Select a memory type first..." required></textarea>
        </div>
        
        <div class="form-group" id="captionField" style="display: none;">
          <label for="memoryCaption">Caption (optional)</label>
          <input type="text" id="memoryCaption" name="caption" placeholder="A short description">
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit">Create Memory</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // Polyfill for window.storage if not available (fallback to localStorage)
    if (typeof window.storage === 'undefined') {
      console.log('window.storage not available, using localStorage fallback');
      window.storage = {
        async set(key, value) {
          localStorage.setItem(key, value);
          return { success: true };
        },
        async get(key) {
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        },
        async list(prefix) {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(prefix)) {
              keys.push(key);
            }
          }
          return { keys };
        },
        async delete(key) {
          localStorage.removeItem(key);
          return { success: true };
        }
      };
    }
    
    class MemoryScrapbookApp {
      constructor() {
        this.memories = [];
        this.currentView = 'grid';
        this.currentScrollIndex = 0;
        this.landingActive = true;
        
        this.init();
      }
      
      async init() {
        // Load memories from storage FIRST
        await this.loadMemories();
        
        // Setup photo stream on landing page
        this.setupPhotoStream();
        
        // Setup event listeners
        this.setupEventListeners();
        
        // Don't render main content until landing is dismissed
      }
      
      async loadMemories() {
        try {
          const result = await window.storage.list('memory:');
          if (result && result.keys && result.keys.length > 0) {
            const memoryPromises = result.keys.map(async key => {
              const data = await window.storage.get(key);
              return data ? JSON.parse(data.value) : null;
            });
            this.memories = (await Promise.all(memoryPromises)).filter(Boolean);
            this.memories.sort((a, b) => new Date(b.date) - new Date(a.date));
            console.log(`Loaded ${this.memories.length} memories from storage`);
          } else {
            // No saved memories, use demo data
            console.log('No saved memories found, loading demo data');
            this.loadDemoData();
          }
        } catch (error) {
          console.error('Failed to load memories:', error);
          // Fallback to demo data
          this.loadDemoData();
        }
      }
      
      loadDemoData() {
        // Demo memories to showcase the grid
        this.memories = [
          {
            id: 'memory_1',
            type: 'letter',
            date: '2024-02-10',
            title: 'First Letter',
            content: 'This is a beautiful letter filled with thoughts and memories...',
            caption: 'A heartfelt message'
          },
          {
            id: 'memory_2',
            type: 'photo',
            date: '2024-02-08',
            title: 'Sunset Together',
            content: 'https://images.unsplash.com/photo-1495567720989-cebdbdd97913?w=400',
            caption: 'The most beautiful sunset we watched together'
          },
          {
            id: 'memory_3',
            type: 'video',
            date: '2024-01-28',
            title: 'Birthday Celebration',
            content: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
            caption: 'Your special day'
          }
        ];
        
        // Sort chronologically (newest first)
        this.memories.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      
      setupPhotoStream() {
        const photoStreamContainer = document.getElementById('photoStream');
        
        // Use all photos from landing page photos directory
        const landingPagePhotos = [
          'landing page photos/001_Original.jpg',
          'landing page photos/027_Original.jpg',
          'landing page photos/114_Original.jpg',
          'landing page photos/211_Original.jpg',
          'landing page photos/CIMG9720.jpg',
          'landing page photos/IMG_0485.JPG',
          'landing page photos/IMG_0488.HEIC',
          'landing page photos/IMG_0526.HEIC',
          'landing page photos/IMG_1651.HEIC',
          'landing page photos/IMG_1684.HEIC',
          'landing page photos/IMG_2449.HEIC',
          'landing page photos/IMG_3149.HEIC',
          'landing page photos/IMG_3324.JPG',
          'landing page photos/IMG_3522.HEIC',
          'landing page photos/IMG_3583.HEIC',
          'landing page photos/IMG_4064.HEIC',
          'landing page photos/IMG_6957.HEIC',
          'landing page photos/IMG_8901.heic',
          'landing page photos/IMG_9090.HEIC',
          'landing page photos/IMG_9229.HEIC',
          'landing page photos/IMG_9933.jpg'
        ];
        
        // Randomize the photo order using Fisher-Yates shuffle
        const shuffleArray = (array) => {
          const shuffled = [...array];
          for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }
          return shuffled;
        };
        
        const randomizedPhotos = shuffleArray(landingPagePhotos);
        
        // Calculate even spacing for photos to avoid overlap
        const totalPhotos = randomizedPhotos.length;
        const verticalSpacing = 60 / totalPhotos; // Divide middle 60% of screen for better spread
        
        // Create photos with proper spacing - NO DUPLICATES
        randomizedPhotos.forEach((photoUrl, index) => {
          const container = document.createElement('div');
          container.className = 'photo-stream-item';
          
          // Evenly distribute vertically to prevent overlap
          const basePosition = 15 + (index * verticalSpacing);
          const randomOffset = (Math.random() - 0.5) * 2; // Minimal random variation to avoid collision
          const topPosition = basePosition + randomOffset;
          container.style.top = `${topPosition}%`;
          
          // Start from right side of screen (off-screen)
          container.style.left = '100vw';
          
          // Varied animation speeds (slower)
          const duration = 18 + (index % 3) * 4; // 18, 22, or 26 seconds
          container.style.animationDuration = `${duration}s`;
          
          // Staggered start times for continuous flow - smaller gaps to fill empty spaces
          const delay = -(index * 1.2); // Stagger by 1.2 seconds each for tighter spacing
          container.style.animationDelay = `${delay}s`;
          
          // Alternate z-index for layering
          const zIndex = index % 2 === 0 ? 15 : 5;
          container.style.zIndex = zIndex;
          
          const img = document.createElement('img');
          img.src = photoUrl;
          img.alt = 'Memory photo';
          img.className = 'stream-photo';
          img.onerror = () => img.style.display = 'none';
          
          container.appendChild(img);
          photoStreamContainer.appendChild(container);
        });
      }
      
      enterScrapbook() {
        this.landingActive = false;
        const landingPage = document.getElementById('landingPage');
        landingPage.classList.add('hidden');
        
        // Render main content after transition
        setTimeout(() => {
          this.render();
        }, 100);
      }
      
      setupEventListeners() {
        // Landing page title click
        document.getElementById('landingTitle').addEventListener('click', () => {
          this.enterScrapbook();
        });
        
        // View switching buttons
        const viewButtons = document.querySelectorAll('.view-btn');
        viewButtons.forEach(btn => {
          btn.addEventListener('click', (e) => {
            const view = e.target.dataset.view;
            this.switchView(view);
          });
        });
        
        // Create memory button
        document.getElementById('createMemoryBtn').addEventListener('click', () => {
          this.openCreateModal();
        });
        
        // Cancel button
        document.getElementById('cancelBtn').addEventListener('click', () => {
          this.closeCreateModal();
        });
        
        // Close modal on backdrop click
        document.getElementById('createMemoryModal').addEventListener('click', (e) => {
          if (e.target.id === 'createMemoryModal') {
            this.closeCreateModal();
          }
        });
        
        // Memory type selection
        const typeOptions = document.querySelectorAll('.type-option');
        typeOptions.forEach(option => {
          option.addEventListener('click', (e) => {
            const selectedType = e.currentTarget.dataset.type;
            this.selectMemoryType(selectedType);
          });
        });
        
        // Form submission
        document.getElementById('createMemoryForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.handleCreateMemory(e);
        });
      }
      
      switchView(view) {
        this.currentView = view;
        
        // Update active button
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === view);
        });
        
        // Re-render
        this.render();
      }
      
      openCreateModal() {
        const modal = document.getElementById('createMemoryModal');
        modal.classList.add('active');
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('memoryDate').value = today;
      }
      
      closeCreateModal() {
        const modal = document.getElementById('createMemoryModal');
        modal.classList.remove('active');
        
        // Reset form
        document.getElementById('createMemoryForm').reset();
        document.querySelectorAll('.type-option').forEach(option => {
          option.classList.remove('active');
        });
        document.getElementById('memoryType').value = '';
        
        // Hide caption field on close
        document.getElementById('captionField').style.display = 'none';
        document.getElementById('memoryContent').placeholder = 'Select a memory type first...';
      }
      
      selectMemoryType(type) {
        // Update UI
        document.querySelectorAll('.type-option').forEach(option => {
          option.classList.toggle('active', option.dataset.type === type);
        });
        
        // Set hidden input value
        document.getElementById('memoryType').value = type;
        
        // Progressive disclosure: Show caption field only for photo/video
        const captionField = document.getElementById('captionField');
        const contentField = document.getElementById('memoryContent');
        
        if (type === 'photo' || type === 'video') {
          captionField.style.display = 'block';
          contentField.placeholder = `URL to ${type}`;
        } else if (type === 'letter') {
          captionField.style.display = 'none';
          contentField.placeholder = 'Your message...';
        }
      }
      
      async handleCreateMemory(e) {
        const formData = new FormData(e.target);
        const memoryData = {
          id: 'memory_' + Date.now(),
          type: formData.get('type'),
          title: formData.get('title'),
          date: formData.get('date'),
          content: formData.get('content') || '',
          caption: formData.get('caption') || ''
        };
        
        // Validate that a type is selected
        if (!memoryData.type) {
          alert('Please select a memory type');
          return;
        }
        
        // Auto-save immediately
        const saved = await this.saveMemory(memoryData);
        
        if (saved) {
          // Close modal and re-render
          this.closeCreateModal();
          this.render();
          console.log('Memory created and saved:', memoryData);
        }
      }
      
      async saveMemory(memoryData) {
        try {
          // Save to storage immediately
          await window.storage.set(`memory:${memoryData.id}`, JSON.stringify(memoryData));
          
          // Update in-memory array
          this.addMemoryToArray(memoryData);
          
          console.log('Memory auto-saved successfully');
          return true;
        } catch (error) {
          console.error('Auto-save failed:', error);
          alert('Failed to save memory. Please try again.');
          return false;
        }
      }
      
      addMemoryToArray(memoryData) {
        // Check if memory already exists
        const existingIndex = this.memories.findIndex(m => m.id === memoryData.id);
        if (existingIndex >= 0) {
          this.memories[existingIndex] = memoryData;
        } else {
          this.memories.push(memoryData);
        }
        
        // Re-sort chronologically (newest first)
        this.memories.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      
      render() {
        const contentContainer = document.getElementById('app-content');
        
        if (this.currentView === 'grid') {
          contentContainer.innerHTML = this.renderGridView();
        } else {
          contentContainer.innerHTML = '<div class="content-placeholder"><p>3D Scroll View coming soon...</p></div>';
        }
      }
      
      renderGridView() {
        if (this.memories.length === 0) {
          return '<div class="content-placeholder"><p>No memories yet. Create your first one!</p></div>';
        }
        
        const cardsHTML = this.memories.map(memory => {
          const formattedDate = new Date(memory.date).toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });
          
          // For photos and videos, use content as image URL
          // For letters, show gradient placeholder
          let imageDisplay = '';
          if (memory.type === 'photo' && memory.content) {
            imageDisplay = `<img src="${memory.content}" alt="${memory.title}" class="memory-card-image" onerror="this.style.display='none'">`;
          } else if (memory.type === 'video' && memory.content) {
            // For videos, try to get a thumbnail or show a gradient
            imageDisplay = '<div class="memory-card-image"></div>';
          } else {
            imageDisplay = '<div class="memory-card-image"></div>';
          }
          
          return `
            <div class="memory-card" data-id="${memory.id}">
              ${imageDisplay}
              <div class="memory-card-content">
                <div class="memory-card-type">${memory.type}</div>
                <h3 class="memory-card-title">${memory.title}</h3>
                ${memory.caption ? `<p class="memory-caption">${memory.caption}</p>` : ''}
                <div class="memory-card-date">${formattedDate}</div>
              </div>
            </div>
          `;
        }).join('');
        
        return `<div class="grid-view">${cardsHTML}</div>`;
      }
    }
    
    // Initialize app when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new MemoryScrapbookApp();
      console.log('Memory Scrapbook App initialized');
    });
  </script>
</body>
</html>
